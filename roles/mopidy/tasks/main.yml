- name: Install pulseaudio
  ansible.builtin.package:
    name:
      - pulseaudio
    state: present

- name: Enable and start pulseaudio
  ansible.builtin.systemd_service:
    name: pulseaudio
    state: started
    enabled: true
    scope: user
  become: true
  become_user: "{{ user }}"

- name: Install mopidy
  ansible.builtin.package:
    name:
      - mopidy
      - mopidy-local
      - mopidy-doc
      - python3-pip
      - python3-standard-imghdr
    state: present

- name: Install Mopidy-Iris python package
  ansible.builtin.pip:
    name: Mopidy-Iris
    break_system_packages: true

- name: Add configuration file
  ansible.builtin.copy:
    dest: /etc/mopidy/mopidy.conf
    content: |
      [core]
      restore_state = true

      [local]
      enabled = true
      media_dir = /mnt/share/Music
      scan_timeout = 10000

      [file]
      enabled = false

      [audio]
      output = pulsesink server=127.0.0.1

      [http]
      enabled = true
      hostname = 0.0.0.0
      port = 6680

      [stream]
      enabled = false
    mode: u=rw,g=r,o=r
  notify: Restart mopidy

- name: Create pulseaudio mopidy config
  ansible.builtin.copy:
    dest: /etc/pulse/default.pa.d/mopidy.pa
    content: |
      load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1
    mode: u=rw,g=r,o=r
  notify: Restart pulseaudio

- name: Allow mopidy in ufw
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - 6680

- name: Enable and start mopidy
  ansible.builtin.systemd_service:
    name: mopidy
    state: started
    enabled: true
