---
- name: Configures all rpis
  gather_facts: false
  tags: common
  hosts: kitchen_pi,tv_pi
  tasks:
    - name: Configure ssh authorized keys
      ansible.posix.authorized_key:
        user: "{{ user }}"
        exclusive: true
        key: "{{ ssh_authorized_keys | join('\n') }}"
      when: ssh_authorized_keys != None and ssh_authorized_keys | length > 0
    - name: Install packages
      ansible.builtin.package:
        name:
          - vim
        state: present
    - name: Remove dphys-swapfile
      ansible.builtin.package:
        name: dphys-swapfile
        state: absent
    - name: Create sysctl directory
      ansible.builtin.file:
        path: /etc/sysctl.d
        state: directory
        mode: u=rwx,g=rx,o=rx
    - name: Set sysctl
      ansible.posix.sysctl:
        sysctl_file: /etc/sysctl.d/rpi.conf
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
      loop: "{{ sysctl_vars }}"
    - name: Install ufw
      ansible.builtin.package:
        name: ufw
        state: present
    - name: Allow ssh
      community.general.ufw:
        rule: allow
        name: OpenSSH
    - name: Enable UFW
      community.general.ufw:
        state: enabled

- name: Configures kitchen pi
  gather_facts: false
  tags: common
  hosts: kitchen_pi
  tasks:
    - name: Mount NAS drive
      ansible.posix.mount:
        path: /mnt/share
        src: UUID=394bcd8a-281d-4c0b-ad20-00e1d06844af
        fstype: ext4
        state: mounted
        passno: 2
    - name: Disable wifi
      ansible.builtin.lineinfile:
        path: /boot/firmware/config.txt
        regexp: 'dtoverlay=disable-wifi'
        line: dtoverlay=disable-wifi
      notify: Restart
    - name: Disable bluetooth
      ansible.builtin.lineinfile:
        path: /boot/firmware/config.txt
        regexp: 'dtoverlay=disable-bt'
        line: dtoverlay=disable-bt
      notify: Restart
  handlers:
    - name: Restart
      ansible.builtin.reboot:

- name: Create samba share on kitchen_pi
  gather_facts: false
  tags: roles
  hosts: kitchen_pi
  roles:
    - role: samba
      tags: samba

- name: Configures tv pi
  gather_facts: false
  tags: common
  hosts: tv_pi
  tasks:
    - name: Mount samba share
      ansible.posix.mount:
        path: /mnt/share
        src: //kitchen-pi.local/share
        fstype: cifs
        state: mounted
        opts: guest,_netdev,x-systemd.automount
    - name: Disable wifi
      ansible.builtin.lineinfile:
        path: /boot/firmware/config.txt
        regexp: 'dtoverlay=disable-wifi'
        line: dtoverlay=disable-wifi
      notify: Restart
  handlers:
    - name: Restart
      ansible.builtin.reboot:

- name: Configures tv_pi roles
  gather_facts: false
  tags: roles
  hosts: tv_pi
  roles:
    - role: bluetooth
      tags: bluetooth
    - role: snapserver
      tags: snapserver
    - role: mopidy
      tags: mopidy

- name: Configures all rpis roles
  gather_facts: false
  tags: roles
  hosts: kitchen_pi,tv_pi
  roles:
    - role: snapclient
      tags: snapclient
    - role: zram
      tags: zram
    - role: log2ram
      tags: log2ram
